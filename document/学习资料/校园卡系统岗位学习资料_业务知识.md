# 校园卡系统业务知识

## 一、校园卡系统概述

### 1.1 系统简介

校园卡系统（也称"一卡通系统"）是集身份识别、电子支付、信息查询等功能于一体的综合性应用系统，是数字化校园建设的重要组成部分。

### 1.2 系统功能

#### 核心功能
1. **身份识别**
   - 门禁管理
   - 考勤管理
   - 图书借阅
   - 机房上机

2. **电子支付**
   - 食堂消费
   - 超市购物
   - 水电缴费
   - 洗浴消费

3. **信息服务**
   - 余额查询
   - 消费记录
   - 挂失解挂
   - 补助发放

4. **管理功能**
   - 开卡销户
   - 充值管理
   - 对账结算
   - 数据统计

### 1.3 系统架构

```
┌─────────────────────────────────────────┐
│           应用层（前端系统）              │
├─────────────────────────────────────────┤
│  卡务管理  │  财务结算  │  数据统计      │
│  自助服务  │  商户管理  │  系统配置      │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│          业务层（应用服务器）             │
├─────────────────────────────────────────┤
│  交易处理  │  账户管理  │  权限控制      │
│  数据同步  │  日志审计  │  接口服务      │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│          数据层（数据库服务器）           │
├─────────────────────────────────────────┤
│  用户信息  │  交易记录  │  商户信息      │
│  设备信息  │  系统配置  │  日志数据      │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│          终端层（硬件设备）               │
├─────────────────────────────────────────┤
│  POS机    │  门禁机    │  自助终端      │
│  读卡器   │  圈存机    │  水控机        │
└─────────────────────────────────────────┘
```

---

## 二、卡务管理业务

### 2.1 开卡流程

```
学生报到 → 信息采集 → 制卡 → 发卡 → 激活 → 正常使用
```

#### 开卡操作步骤
1. **信息录入**
   - 学号、姓名、院系、班级
   - 身份证号、联系方式
   - 照片采集

2. **卡片制作**
   - 写入卡号
   - 关联学号
   - 设置初始密码

3. **账户开通**
   - 创建账户
   - 设置初始余额
   - 开通权限

4. **发卡登记**
   - 记录发卡时间
   - 学生签字确认
   - 激活卡片

### 2.2 充值业务

#### 充值方式
1. **现金充值**
   - 充值点人工充值
   - 自助充值机
   
2. **银行卡转账**
   - 圈存机转账
   - 网上银行转账
   
3. **移动支付**
   - 微信充值
   - 支付宝充值
   - 校园APP充值

#### 充值流程
```sql
-- 充值事务处理
BEGIN TRANSACTION;

-- 1. 验证卡片状态
SELECT status FROM campus_cards WHERE card_id = 'C001';

-- 2. 更新余额
UPDATE campus_cards 
SET balance = balance + 100,
    last_recharge_time = NOW()
WHERE card_id = 'C001';

-- 3. 记录充值流水
INSERT INTO transactions (
    card_id, amount, transaction_type, 
    transaction_time, operator
) VALUES (
    'C001', 100, 'recharge', 
    NOW(), 'admin'
);

-- 4. 更新统计数据
UPDATE daily_statistics 
SET recharge_count = recharge_count + 1,
    recharge_amount = recharge_amount + 100
WHERE stat_date = CURDATE();

COMMIT;
```

### 2.3 挂失与解挂

#### 挂失流程
1. **挂失申请**
   - 学生提交挂失申请
   - 验证身份信息
   - 记录挂失时间

2. **冻结账户**
   ```sql
   UPDATE campus_cards 
   SET status = 'lost',
       lost_time = NOW()
   WHERE card_id = 'C001';
   ```

3. **停止交易**
   - 终端设备同步黑名单
   - 拒绝该卡所有交易

#### 解挂流程
1. **找回卡片**
   - 学生申请解挂
   - 验证身份

2. **恢复账户**
   ```sql
   UPDATE campus_cards 
   SET status = 'active',
       lost_time = NULL
   WHERE card_id = 'C001';
   ```

#### 补卡流程
1. **申请补卡**
   - 提交补卡申请
   - 缴纳工本费

2. **制作新卡**
   - 生成新卡号
   - 转移原卡余额

3. **注销旧卡**
   ```sql
   -- 转移余额到新卡
   UPDATE campus_cards 
   SET balance = (SELECT balance FROM campus_cards WHERE card_id = 'C001_OLD')
   WHERE card_id = 'C001_NEW';
   
   -- 注销旧卡
   UPDATE campus_cards 
   SET status = 'cancelled'
   WHERE card_id = 'C001_OLD';
   ```

### 2.4 销户流程

```
申请销户 → 验证身份 → 结算余额 → 注销账户 → 回收卡片
```

#### 销户操作
```sql
BEGIN TRANSACTION;

-- 1. 检查卡片状态
SELECT status, balance FROM campus_cards WHERE card_id = 'C001';

-- 2. 退还余额
INSERT INTO refund_records (
    card_id, amount, refund_time, operator
) VALUES (
    'C001', 150.50, NOW(), 'admin'
);

-- 3. 注销卡片
UPDATE campus_cards 
SET status = 'closed',
    close_time = NOW(),
    balance = 0
WHERE card_id = 'C001';

-- 4. 记录销户日志
INSERT INTO operation_logs (
    operation_type, card_id, operator, operation_time
) VALUES (
    'close_account', 'C001', 'admin', NOW()
);

COMMIT;
```

---

## 三、消费与结算

### 3.1 消费流程

```
刷卡 → 读取卡信息 → 验证余额 → 扣款 → 更新余额 → 打印小票
```

#### POS机消费处理
```python
def process_transaction(card_id, merchant_id, amount):
    """处理消费交易"""
    try:
        # 1. 读取卡信息
        card = get_card_info(card_id)
        
        # 2. 验证卡片状态
        if card.status != 'active':
            return {'success': False, 'message': '卡片状态异常'}
        
        # 3. 验证余额
        if card.balance < amount:
            return {'success': False, 'message': '余额不足'}
        
        # 4. 扣款
        new_balance = card.balance - amount
        update_balance(card_id, new_balance)
        
        # 5. 记录交易
        transaction_id = save_transaction(
            card_id=card_id,
            merchant_id=merchant_id,
            amount=amount,
            transaction_type='consume',
            balance_before=card.balance,
            balance_after=new_balance
        )
        
        # 6. 返回结果
        return {
            'success': True,
            'transaction_id': transaction_id,
            'balance': new_balance
        }
    except Exception as e:
        log_error(f"交易失败: {str(e)}")
        return {'success': False, 'message': '系统错误'}
```

### 3.2 商户结算

#### 结算周期
- **日结**：每日营业结束后结算
- **周结**：每周统一结算
- **月结**：每月统一结算

#### 结算流程
```sql
-- 生成商户日结报表
SELECT 
    merchant_id,
    merchant_name,
    COUNT(*) as transaction_count,
    SUM(amount) as total_amount,
    DATE(transaction_time) as settle_date
FROM transactions t
JOIN merchants m ON t.merchant_id = m.merchant_id
WHERE DATE(transaction_time) = CURDATE()
  AND transaction_type = 'consume'
GROUP BY merchant_id, merchant_name;

-- 计算手续费
UPDATE merchant_settlements
SET fee = total_amount * 0.01,  -- 1%手续费
    net_amount = total_amount * 0.99
WHERE settle_date = CURDATE();
```

### 3.3 对账管理

#### 对账内容
1. **交易对账**
   - POS机流水 vs 数据库记录
   - 交易笔数、金额核对

2. **余额对账**
   - 卡片余额 vs 账户余额
   - 发现异常及时处理

3. **商户对账**
   - 商户流水 vs 平台记录
   - 结算金额核对

#### 对账脚本
```bash
#!/bin/bash
# 每日对账脚本

DATE=$(date +%Y%m%d)
LOG_FILE="/var/log/reconciliation_${DATE}.log"

echo "[$(date)] 开始对账" >> $LOG_FILE

# 1. 导出POS机流水
mysql -u root -p -e "
    SELECT * FROM transactions 
    WHERE DATE(transaction_time) = CURDATE()
" > /tmp/db_transactions_${DATE}.csv

# 2. 对比POS机文件和数据库记录
# （实际需要从POS机导出数据）

# 3. 检查余额一致性
mysql -u root -p -e "
    SELECT card_id, balance 
    FROM campus_cards 
    WHERE status = 'active'
" > /tmp/card_balance_${DATE}.csv

# 4. 生成对账报告
echo "[$(date)] 对账完成" >> $LOG_FILE
```

---

## 四、设备运维

### 4.1 终端设备类型

#### 1. POS消费机
**功能**：
- 刷卡消费
- 余额查询
- 交易记录

**常见故障**：
- 读卡失败
- 网络断开
- 打印机故障

**维护要点**：
- 定期清洁读卡器
- 检查网络连接
- 更换打印纸

#### 2. 门禁设备
**功能**：
- 身份验证
- 门禁控制
- 考勤记录

**常见故障**：
- 刷卡无反应
- 门禁失灵
- 时间不准

**维护要点**：
- 检查电源供电
- 同步系统时间
- 更新权限数据

#### 3. 自助终端
**功能**：
- 自助充值
- 信息查询
- 密码修改

**常见故障**：
- 触摸屏失灵
- 现金识别错误
- 系统死机

**维护要点**：
- 清洁触摸屏
- 校准纸币器
- 定期重启系统

#### 4. 圈存机
**功能**：
- 银行卡转账
- 校园卡充值

**常见故障**：
- 银行卡读取失败
- 转账不成功
- 凭条打印异常

**维护要点**：
- 检查银行接口
- 测试转账功能
- 补充打印纸

### 4.2 设备配置管理

#### 设备信息表
```sql
CREATE TABLE devices (
    device_id VARCHAR(20) PRIMARY KEY,
    device_type VARCHAR(20),  -- POS/门禁/自助终端
    device_name VARCHAR(50),
    location VARCHAR(100),
    ip_address VARCHAR(15),
    mac_address VARCHAR(17),
    status VARCHAR(10),  -- online/offline/fault
    install_date DATE,
    last_maintain_date DATE,
    remarks TEXT
);
```

#### 设备监控
```python
def check_device_status():
    """检查设备在线状态"""
    devices = get_all_devices()
    
    for device in devices:
        # Ping测试
        response = os.system(f"ping -c 1 {device.ip_address} > /dev/null 2>&1")
        
        if response == 0:
            update_device_status(device.device_id, 'online')
        else:
            update_device_status(device.device_id, 'offline')
            send_alert(f"设备离线: {device.device_name}")
```

### 4.3 故障处理流程

```
故障报修 → 故障登记 → 现场排查 → 故障处理 → 测试验收 → 记录归档
```

#### 常见故障处理

**问题1：POS机无法联网**
```
排查步骤：
1. 检查网线连接
2. ping网关测试
3. 检查交换机端口
4. 查看设备IP配置
5. 重启设备
```

**问题2：读卡器读卡失败**
```
排查步骤：
1. 清洁读卡器
2. 测试其他卡片
3. 检查卡片是否损坏
4. 更换读卡器模块
5. 检查驱动程序
```

**问题3：数据不同步**
```
排查步骤：
1. 检查网络连接
2. 查看同步日志
3. 手动触发同步
4. 检查数据库连接
5. 重启同步服务
```

---

## 五、数据管理

### 5.1 数据备份策略

#### 备份方案
1. **全量备份**：每天凌晨2点
2. **增量备份**：每小时一次
3. **异地备份**：每天同步到备份中心
4. **保留周期**：30天

#### 备份脚本
```bash
#!/bin/bash
# 校园卡数据库备份脚本

DB_NAME="campus_card_db"
BACKUP_DIR="/backup/database"
DATE=$(date +%Y%m%d_%H%M%S)

# 全量备份
mysqldump -u root -p --single-transaction \
    --master-data=2 --flush-logs \
    $DB_NAME | gzip > $BACKUP_DIR/full_${DATE}.sql.gz

# 上传到备份服务器
rsync -avz $BACKUP_DIR/full_${DATE}.sql.gz \
    backup@192.168.1.100:/backup/

# 清理旧备份
find $BACKUP_DIR -name "full_*.sql.gz" -mtime +30 -delete
```

### 5.2 数据统计分析

#### 日常统计报表
```sql
-- 每日交易统计
SELECT 
    DATE(transaction_time) as date,
    COUNT(*) as transaction_count,
    SUM(CASE WHEN transaction_type='consume' THEN amount ELSE 0 END) as consume_total,
    SUM(CASE WHEN transaction_type='recharge' THEN amount ELSE 0 END) as recharge_total
FROM transactions
WHERE DATE(transaction_time) = CURDATE()
GROUP BY DATE(transaction_time);

-- 商户排行
SELECT 
    m.merchant_name,
    COUNT(*) as transaction_count,
    SUM(t.amount) as total_amount
FROM transactions t
JOIN merchants m ON t.merchant_id = m.merchant_id
WHERE DATE(t.transaction_time) = CURDATE()
  AND t.transaction_type = 'consume'
GROUP BY m.merchant_id, m.merchant_name
ORDER BY total_amount DESC
LIMIT 10;

-- 学院消费统计
SELECT 
    s.department,
    COUNT(DISTINCT c.card_id) as card_count,
    SUM(t.amount) as total_consume
FROM students s
JOIN campus_cards c ON s.student_id = c.student_id
JOIN transactions t ON c.card_id = t.card_id
WHERE DATE(t.transaction_time) = CURDATE()
  AND t.transaction_type = 'consume'
GROUP BY s.department
ORDER BY total_consume DESC;
```

### 5.3 数据安全

#### 安全措施
1. **访问控制**
   - 最小权限原则
   - 定期审计账户
   - 强密码策略

2. **数据加密**
   - 敏感数据加密存储
   - 传输层SSL加密
   - 密码哈希存储

3. **日志审计**
   - 记录所有操作日志
   - 定期审计异常操作
   - 保留日志6个月以上

4. **容灾备份**
   - 主备数据库
   - 异地灾备
   - 定期演练恢复

---

## 六、系统维护

### 6.1 日常维护任务

#### 每日任务
- [ ] 检查系统运行状态
- [ ] 查看错误日志
- [ ] 监控数据库性能
- [ ] 检查设备在线率
- [ ] 处理用户报修

#### 每周任务
- [ ] 数据库性能优化
- [ ] 清理临时文件
- [ ] 更新系统补丁
- [ ] 巡检重要设备
- [ ] 生成周报

#### 每月任务
- [ ] 全面系统检查
- [ ] 数据备份验证
- [ ] 安全漏洞扫描
- [ ] 设备维护保养
- [ ] 生成月报

### 6.2 应急预案

#### 数据库故障
```
1. 立即切换到备库
2. 排查主库故障原因
3. 修复主库问题
4. 数据同步验证
5. 切回主库运行
```

#### 网络中断
```
1. 启用备用网络链路
2. 排查网络故障
3. 联系网络运营商
4. 修复网络连接
5. 恢复正常服务
```

#### 系统被攻击
```
1. 隔离受影响系统
2. 分析攻击来源
3. 封禁攻击IP
4. 修复安全漏洞
5. 恢复系统服务
6. 加强安全防护
```

---

## 七、实战案例

### 案例1：大规模充值活动
**场景**：开学季，5000名新生集中办卡充值

**解决方案**：
1. 提前扩容服务器
2. 增加充值窗口
3. 优化数据库性能
4. 部署负载均衡
5. 实时监控系统

### 案例2：设备批量故障
**场景**：某食堂10台POS机同时离线

**排查过程**：
1. 检查网络连接 → 正常
2. 检查交换机 → 发现交换机故障
3. 更换交换机
4. 设备恢复正常

### 案例3：数据异常处理
**场景**：发现部分学生余额异常增加

**处理步骤**：
1. 查询异常交易记录
2. 分析日志找出原因
3. 修复系统漏洞
4. 回滚异常数据
5. 通知相关学生

---

**学习建议**：
1. 了解校园卡系统整体架构
2. 熟悉卡务管理各项业务流程
3. 掌握常见设备故障处理方法
4. 学习数据备份和恢复操作
5. 关注系统安全和应急处理
